<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DIR ACE Technology</title>
    <meta content="" name="description">
    <meta content="" name="keywords">

    <link href="https://fonts.gstatic.com" rel="preconnect">
    <link href="https://fonts.googleapis.com/css?family=Open+Sans:300,300i,400,400i,600,600i,700,700i|Nunito:300,300i,400,400i,600,600i,700,700i|Poppins:300,300i,400,400i,500,500i,600,600i,700,700i" rel="stylesheet">
    <link th:href="@{/static/assets/img/download.png}" rel="icon">
    <link th:href="@{/assets/img/download.png}" rel="apple-touch-icon">

    <link href="https://fonts.gstatic.com" rel="preconnect">
    <link href="https://fonts.googleapis.com/css?family=Open+Sans:300,300i,400,400i,600,600i,700,700i|Nunito:300,300i,400,400i,600,600i,700,700i|Poppins:300,300i,400,400i,500,500i,600,600i,700,700i" rel="stylesheet">

    <!-- Vendor CSS Files -->
    <link th:href="@{/static/assets/vendor/bootstrap/css/bootstrap.min.css}" rel="stylesheet">
    <link th:href="@{/static/assets/vendor/bootstrap-icons/bootstrap-icons.css}" rel="stylesheet">
    <link th:href="@{/static/assets/vendor/boxicons/css/boxicons.min.css}" rel="stylesheet">
    <link th:href="@{/static/assets/vendor/quill/quill.snow.css}" rel="stylesheet">
    <link th:href="@{/static/assets/vendor/quill/quill.bubble.css}" rel="stylesheet">
    <link th:href="@{/static/assets/vendor/remixicon/remixicon.css}" rel="stylesheet">
    <link th:href="@{/static/assets/vendor/simple-datatables/style.css}" rel="stylesheet">

    <link th:href="@{/static/assets/css/style.css}" rel="stylesheet">
    <link th:href="@{/static/assets/css/post.css}" rel="stylesheet">
    <link th:href="@{/static/assets/css/all.css}" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/sockjs-client/dist/sockjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/stompjs/lib/stomp.min.js"></script>
    <link rel="stylesheet" th:href="@{/static/assets/css/group.css}">
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" integrity="sha512-SnH5WK+bZxgPHs44uWIX+LLJAJ9/2PkPKZ5QiAj6Ta86w+fsb2TkcmfRyVX3pBnMFcV7oQPJkl9QevSCWr3W6A==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css">
    <script src="https://cdn.jsdelivr.net/npm/toastify-js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.slim.js" integrity="sha512-docBEeq28CCaXCXN7cINkyQs0pRszdQsVBFWUd+pLNlEk3LDlSDDtN7i1H+nTB8tshJPQHS0yu0GW9YGFd/CRg==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css">
    <link href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet">

</head>
<style>
    .community-card {
        border: 1px solid #ddd;
        border-radius: 8px;
        overflow: hidden;
        width: 100%;
        max-width: 400px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        margin: 10px;
        display: flex;
        flex-direction: column;
        align-items: center; /* Center items horizontally */
    }

    .community-card .card-body {
        padding: 16px;
        display: flex;
        flex-direction: column;
        align-items: center; /* Center items horizontally */
        text-align: center; /* Center text */
    }

    .community-card .card-title {
        font-size: 1.5em;
        margin-bottom: 10px;
    }

    .community-card .community-image {
        width: 100px;
        height: 100px;
        background-size: cover;
        background-position: center;
        margin-bottom: 15px;
        border-radius: 50px;
    }

    .community-card .card-text {
        margin: 5px 0;
    }

    .community-card .text-container {
        display: flex;
        gap: 5px;
        margin: 10px 0;
        justify-content: center; /* Center member images */
    }

    .community-card .btn-danger {
        background-color: #dc3545;
        color: white;
        border: none;
        padding: 10px;
        cursor: pointer;
        border-radius: 4px;
    }

    .community-card .btn-danger:hover {
        background-color: #c82333;
    }

    .button {
        border: none;
        padding: 8px;
        color: white;
        background-color: #449D44;
        text-align: center;
        cursor: pointer;
        width: 100%;
        margin-bottom: 10px;
    }

    .custom-btn {
        width: 130px;
        height: 40px;
        color: #fff;
        border-radius: 5px;
        padding: 10px 25px;
        font-family: 'Lato', sans-serif;
        font-weight: 500;
        background: transparent;
        cursor: pointer;
        transition: all 0.3s ease;
        position: relative;
        display: inline-block;
        box-shadow:inset 2px 2px 2px 0px rgba(255,255,255,.5),
        7px 7px 20px 0px rgba(0,0,0,.1),
        4px 4px 5px 0px rgba(0,0,0,.1);
        outline: none;
    }

    /* 1 */
    .btn-1 {
        background: rgb(6,14,131);
        background: linear-gradient(0deg, rgba(6,14,131,76) 0%, rgba(47 ,63, 250,78) 100%);
        border: none;
    }
    .modal-header{
        background-color: silver;
    }

</style>

<body>


<div th:include="header"></div>

<!-- ======= Sidebar ======= -->
<div th:include="sidebar"></div>


<main id="main" class="main">

    <div class="container mt-5">
        <button type="button" class="custom-btn btn-1" data-toggle="modal" data-target="#createCommunityModal" style="margin-top: -80px">
            Create</button>


        <button type="button" class="custom-btn btn-1" id="toggleInactiveGroup">
            <i class="fas fa-toggle-off"></i> Toggle Active
        </button>



        <br><br>
        <div id="message" class="alert" style="display: none;"></div>


        <!-- Card Container -->
        <div class="row" id="cardContainer"></div>

        <div id="inactiveCommunityCards" style="display: none;"></div>

        <div class="modal fade" id="createCommunityModal"  tabindex="-1" aria-labelledby="ModalLabel" aria-hidden="true">
            <div class="modal-dialog" role="document">
                <form id="createCommunityForm">
                    <div class="modal-content">
                        <div class="modal-header" >
                            <h5 class="modal-title" id="exampleModalLabel">Create Community</h5>
                            <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                <span aria-hidden="true">&times;</span>
                            </button>
                        </div>
                        <div class="modal-body">
                            <div class="form-group">
                                <label >Name:</label>
                                <input type="text" class="form-control" id="name" name="name">
                                <span id="nameError" class="text-danger"></span>
                            </div>
                            <div class="form-group">
                                <label for="description">Description:</label>
                                <textarea type="text" class="form-control" id="description" name="description"></textarea>
                                <span id="descriptionError" class="text-danger"></span>
                            </div>
                            <div class="form-group">
                                <label for="rule">Rule:</label>
                                <input type="text" class="form-control" id="rule" name="rule">
                                <span id="ruleError" class="text-danger"></span>
                            </div>
                            <div class="form-group">
                                <label for="file">Image:</label>
                                <input type="file" class="form-control" accept="image/*" id="file" name="file">
                                <span id="fileError" class="text-danger"></span>
                            </div>
                            <div class="form-group">
                                <label for="visibility">Visibility:</label>
                                <select class="form-control" id="visibility" name="visibility">
                                    <option selected value="0">Public</option>
                                    <option value="1">Private</option>
                                </select>
                                <span id="visibilityError" class="text-danger"></span>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                            <button type="button" class="btn btn-primary" data-dismiss="modal" id="createCommunityBtn">Create</button>
                        </div>
                    </div>
                </form>
            </div>
        </div>

        <div class="container">
            <div class="row" id="communityList" >
                <!-- Cards will be dynamically added here -->
            </div>
        </div>

        <!-- Delete Confirmation Modal -->
        <div class="modal fade" id="deleteConfirmationModal" tabindex="-1" role="dialog" aria-labelledby="deleteConfirmationModalLabel" aria-hidden="true">
            <div class="modal-dialog" role="document">
                <div class="modal-content" style="width: fit-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="deleteConfirmationModalLabel">Confirm Delete</h5>
                        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                            <span aria-hidden="true">&times;</span>
                        </button>
                    </div>
                    <div class="modal-body">
                        Are you sure you want to delete this community?
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                        <button type="button" class="btn btn-danger" id="confirmDeleteBtn">Delete</button>
                    </div>
                </div>
            </div>
        </div>

        <div class="modal fade" id="staticBackdropForRebuildGroup" data-bs-backdrop="static" data-bs-keyboard="false"
             tabindex="-1" aria-labelledby="staticBackdropLabel" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header" style="background-color: #007bff">
                        <h5 class="modal-title" id="staticBackdropLabelForRebuildGroup" style="color: white"><i class="fa-solid fa-recycle"></i>Reusable
                            group:</h5>
                    </div>
                    <div class="modal-body">
                        <input type="hidden" id="groupIdForRebuild" name="communityId">
                        <div id="RebuildGroupWords"></div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal"
                                id="rebuildGroupCloseBtn">Close
                        </button>
                        <button type="button" class="btn btn-outline-success" id="rebuildGroupSubmitBtn">Change</button>
                    </div>
                </div>
            </div>
        </div>

        <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.9.2/dist/umd/popper.min.js"></script>
        <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
        <script th:src="@{/static/assets/js/successfulmessage.js}"></script>

        <script>
            let communityIdToDelete = null;

            document.getElementById('createCommunityBtn').addEventListener('click', async (e) => {
                e.preventDefault();

                const name = document.getElementById('name').value;
                const description = document.getElementById('description').value;
                const rule = document.getElementById('rule').value;
                const file = document.getElementById('file').value;
                const visibility = document.getElementById('visibility').value;
                console.log("Visibility ",visibility);

                let isValid = true;

                if (name.trim() === '') {
                    document.getElementById('nameError').innerHTML = 'Name is required';
                    isValid = false;
                } else {
                    document.getElementById('nameError').innerHTML = '';
                }

                if (description.trim() === '') {
                    document.getElementById('descriptionError').innerHTML = 'Description is required';
                    isValid = false;
                } else {
                    document.getElementById('descriptionError').innerHTML = '';
                }
                if (rule.trim() === '') {
                    document.getElementById('ruleError').innerHTML = 'Rule is required';
                    isValid = false;
                } else {
                    document.getElementById('ruleError').innerHTML = '';
                }
                if (file.trim() === '') {
                    document.getElementById('fileError').innerHTML = 'Image is required';
                    isValid = false;
                } else {
                    document.getElementById('fileError').innerHTML = '';
                }

                if (isValid) {
                    const formData = new FormData(document.getElementById('createCommunityForm'));
                    console.log(formData);
                    const url = "/createCommunity";
                    const data = await fetch(url, {
                        method: 'POST',
                        body: formData
                    });

                    if (data.ok) {
                        const result = await data.json();
                        if (result) {
                            console.log("Result ", result);
                            showToast('Create Successful', '#595757');
                            // Close the modal
                            $('#createCommunityModal').modal('hide');
                            await fetchCommunities();
                        } else {
                            showToast('Fail to Create', 'red');
                        }
                    } else {
                        showToast('Fail to Create', 'red');
                    }
                }
            });


            document.addEventListener("DOMContentLoaded", function () {
                fetchCommunities();


            });

            async function fetchCommunities() {
                fetch('/communityview')
                    .then(response => response.json())
                    .then(data => {
                        const activeCommunities = data.filter(community => !community.deleted);
                        console.log("Active Group ",activeCommunities);
                        populateTable(activeCommunities);
                    })
                    .catch(error => {
                        console.error('Error fetching communities:', error);
                    });
            }



            async function fetchOwnerNames(communityId) {
                const response = await fetch(`/ownerNames/${communityId}`);
                const data = await response.json();
                return data;
            }


            async function populateTable(communities) {
                const listContainer = document.getElementById('communityList');
                listContainer.innerHTML = '';
                const currentUser = await getCurrentUser();

                for (const community of communities) {
                    const ownerNames = await fetchOwnerNames(community.id);
                    const photoUrl = community.image || 'http://res.cloudinary.com/dwdplsd2c/image/upload/v1712047327/fllinoozg9hh1ghk5mef.png';

                    const defaultImageUrl = 'http://res.cloudinary.com/dwdplsd2c/image/upload/v1712047327/fllinoozg9hh1ghk5mef.png';

                    const memberImages = ownerNames.map(ownerName => {
                        return `<img class="dot" src="${defaultImageUrl}" alt="${ownerName}">`;
                    }).join('');

                    const isActive = !community.deleted;

                    const deleteIconHtml = isActive ? `<span class="delete-icon" onclick="deleteCommunity(${community.id})" style="cursor: pointer; color: red; font-size: 40px; margin-right: auto">&#128465;</span>` : '';
                    const viewButtonHtml = isActive ? `<button class="button view-button" type="button" data-community-id="${community.id}" style="color: black; margin-top: -45px; margin-left: 50px">View</button>` : '';
                    const rebuildButtonHtml = !isActive ? `<button class="button rebuild-button" onclick="rebuildGroup(${community.id})" type="button" data-community-id="${community.id}" style="color: black; margin-top: 10px;">Rebuild</button>` : '';

                    const cardHtml = `
            <div class="col-md-4">
                <div class="card mb-4 community-card" style="border-radius: 50px; border-color: gray; background: rgb(182,212,254);
 background: radial-gradient(circle, rgba(182,212,254,0) 0%, rgba(182,212,254,43) 100%);
  padding: 0; border: none" >
                    <div class="card-body">

                        <div class="community-image" style="background-image: url('${photoUrl}'); width: 100px; height: 100px; background-size: cover; background-position: center; margin: auto ; border-radius: 50px;"></div>
                         <h5 class="card-title">${community.name}</h5>
                        <p class="card-text">${community.description}</p>
                        <p class="card-text ">Rule: ${community.rule}</p>
                        <p class="card-text ">Admin: ${community.ownerUserName}</p>
                        <div class="text-container">${memberImages}</div>
                        ${deleteIconHtml}
                        ${viewButtonHtml}
                         ${rebuildButtonHtml}
                </div>
                </div>
            </div>
        `;

                    listContainer.insertAdjacentHTML('beforeend', cardHtml);
                }
                document.querySelectorAll('.view-button').forEach(button => {
                    button.addEventListener('click', function() {
                        const communityId = this.getAttribute('data-community-id');
                        window.location.href = `/groupPage/${communityId}`;
                    });
                });
            }


            async function getCurrentUser() {
                const response = await fetch('/user/current');
                const data = await response.json();
                console.log(data);
                return data;
            }


            document.getElementById('confirmDeleteBtn').addEventListener('click', async () => {
                if (communityIdToDelete !== null) {
                    try {
                        const url = `/delete/${communityIdToDelete}`;
                        const response = await fetch(url, {
                            method: 'DELETE'
                        });

                        if (response.ok) {
                            // Remove the deleted group from the table
                            const deletedRow = document.getElementById(`row_${communityIdToDelete}`);
                            if (deletedRow) {
                                deletedRow.remove();
                            }
                            showMessage('Community deleted successfully', 'success');
                            communityIdToDelete = null;
                            $('#deleteConfirmationModal').modal('hide');
                            await fetchCommunities();
                        } else {
                            throw new Error('Error deleting community');
                        }
                    } catch (error) {
                        console.error(error);
                        showMessage('Error deleting community', 'error');
                    }
                }
            });

            async function deleteCommunity(communityId) {
                communityIdToDelete = communityId;
                $('#deleteConfirmationModal').modal('show');
            }

            function showMessage(message, type) {
                const messageDiv = document.getElementById('message');
                messageDiv.innerHTML = message;
                messageDiv.className = type === 'success' ? 'alert alert-success' : 'alert alert-danger';
                messageDiv.style.display = 'block';
                setTimeout(() => {
                    messageDiv.style.display = 'none';
                }, 3000);
            }


            let showActive = true;

            document.getElementById('toggleInactiveGroup').addEventListener('click', toggleInactiveGroups);

            async function toggleInactiveGroups() {
                const toggleButton = document.getElementById('toggleInactiveGroup');
                const buttonText = toggleButton.innerText.trim();
                const showActive = buttonText === 'Toggle Active';
                console.log("toggleButton ",toggleButton.innerText);
                if(buttonText === 'Toggle Active'){
                    console.log("Fetch Inactive Group");
                    fetch('/inactive-community-view')
                        .then(response => response.json())
                        .then(data => {
                            populateTable(data);
                            toggleButton.innerHTML = '<i class="fas fa-toggle-on"></i> Show Inactive';
                            // toggleButton.textContent = 'Show Active';
                            showMessage(showActive ? 'Active communities loaded successfully' : 'Inactive communities loaded successfully', 'success');
                        })
                        .catch(error => {
                            console.error('Error toggling communities:', error);
                            showMessage('Error toggling communities', 'error');
                        });
                }
                else{
                    console.log('Fetch Active Group');
                    fetch('/communityview')
                        .then(response => response.json())
                        .then(data => {
                            populateTable(data);
                            toggleButton.innerHTML =  '<i class="fas fa-toggle-off"></i> Toggle Active';
                            toggleButton.textContent = 'Toggle Active';
                            showMessage(showActive ? 'Active communities loaded successfully' : 'Inactive communities loaded successfully', 'success');
                        })
                        .catch(error => {
                            console.error('Error toggling communities:', error);
                            showMessage('Error toggling communities', 'error');
                        });
                }

            }

            async function rebuildGroup(groupId) {
                const toggleButton = document.getElementById('toggleInactiveGroup');
                try {
                    const response = await fetch(`/rebuild-group/${groupId}`, {
                        method: 'POST'
                    });
                    if (response.ok) {
                        toggleButton.innerHTML = '<i class="fas fa-toggle-on"></i> Show Active';
                        toggleButton.innerText ='Toggle Active';
                        showMessage('Group rebuilt successfully', 'success');
                        await fetchCommunities();
                    } else {
                        throw new Error('Failed to rebuild group');
                    }
                } catch (error) {
                    console.error(error);
                    showMessage('Error rebuilding group', 'error');
                }
            }
        </script>


    </div>
</main>

<!-- Place the event listener here, just before the closing </body> tag -->
<script>
    document.getElementById('groupList').addEventListener('click', getCommunities);
</script>



<div th:include="footer"></div>

</body>

<a href="#" class="back-to-top d-flex align-items-center justify-content-center"><i class="bi bi-arrow-up-short"></i></a>

<!-- Vendor JS Files -->
<script th:src="@{/static/assets/vendor/apexcharts/apexcharts.min.js}"></script>
<script th:src="@{/static/assets/vendor/bootstrap/js/bootstrap.bundle.min.js}"></script>
<script th:src="@{/static/assets/vendor/chart.js/chart.umd.js}"></script>
<script th:src="@{/static/assets/vendor/echarts/echarts.min.js}"></script>
<script th:src="@{/static/assets/vendor/quill/quill.min.js}"></script>
<script th:src="@{/static/assets/vendor/simple-datatables/simple-datatables.js}"></script>
<script th:src="@{static/assets/vendor/tinymce/tinymce.min.js}"></script>
<script th:src="@{/static/assets/vendor/php-email-form/validate.js}"></script>

<!-- Template Main JS File -->
<script th:src="@{/static/assets/js/main.js}"></script>
<script th:src="@{/static/assets/js/changeDefaultPassword.js}"></script>


</html>

