<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">

<head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Bootstrap 5 Forgot Password</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<style>
    body {
        background: #c9d6ff linear-gradient(to right, #e2e2e2, #c9d6ff);
    }

    .container {
        margin-top: 50px;
    }

    .card {
        border: none;
        border-radius: 10px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }

    .form-label {
        font-weight: bold;
    }

    button {
        background: #6200EE;
    }
</style>
<body>
<div class="container">
    <div class="row justify-content-center">
        <div class="col-md-5">
            <div class="card">
                <div class="card-body">
                    <div class="mb-4">
                        <h5 style="color: #3700b3;">Verify Code</h5>
                        <p class="mb-2">Enter the OTP sent to your email to verify your account</p>
                    </div>
                    <form th:action="@{/verify}" method="post">
                        <div class="mb-3">
                            <small id="countdown"></small><br>
                            <label for="otp" class="form-label">OTP</label>
                            <small id="otpErrorMessage" style="color: red;"></small>
                            <input type="text" id="otp" class="form-control" name="otp"
                                   placeholder="Enter Your OTP" />
                            <input type="hidden" th:value="${userId}" id="userId" name="hiddenId">
                        </div>
                        <div class="mb-3 d-grid">
                            <button type="submit" id="resetPasswordBtn" class="btn btn-primary">Reset
                                Password</button>
                        </div>
                        <div class="mb-3 d-grid">
                            <a th:href="@{/forgetPassword}">Resend Code</a>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>
</body>

<script>
    const otpInput = document.getElementById('otp');
    let userId = document.getElementById('userId').value;
    let remainingTime = 60;

    // Update the countdown every second
    function startCountdown() {
        let remainingTime = localStorage.getItem('remainingTime');
        if (!remainingTime) {
            remainingTime = 60; // Set default time if not found in local storage
        } else {
            remainingTime = parseInt(remainingTime);
        }

        // Update the countdown every second
        const countdown = setInterval(() => {
            // Decrease remaining time by 1 second
            remainingTime--;

            // Dynamically update the countdown text and color
            document.getElementById('countdown').innerHTML = "OTP Code will be expired in " + `<span style="color: red;">${remainingTime}s</span>`;

            // If remaining time reaches 0, stop the countdown
            if (remainingTime < 1) {
                clearInterval(countdown);
                document.getElementById('countdown').innerHTML = `<span style="color: red">OTP Code is expired!!!</span>`;
                document.getElementById('otp').disabled = true;
                document.getElementById('resetPasswordBtn').disabled = true;
                localStorage.removeItem('remainingTime');
            }
            else{
                // Store remaining time in local storage
                localStorage.setItem('remainingTime', remainingTime.toString());
            }
        }, 1000); // Update every second
    }

    // Call the startCountdown function when the page loads
    window.onload = startCountdown;

    otpInput.oninput=function (){
        let OTPCode = otpInput.value;
        let userIdAndOTPCode ={
            userId:userId,
            otpCode:OTPCode
        };
        console.log(OTPCode,userId)
        checkOTPCode(userIdAndOTPCode);
    };
    const checkOTPCode=(userIdAndOTPCode)=>{
        const url = "/user/verify-OTPCode";
        fetch(url,{
            method:'POST',
            headers:{'Content-type':'application/json'},
            body:JSON.stringify(userIdAndOTPCode)
        })
            .then(response=>response.json())
            .then(valid=>{
                console.log(valid);
                const otpErrorMessage =  document.getElementById('otpErrorMessage');
                const resetPasswordBtn = document.getElementById('resetPasswordBtn');
                if(valid==false){
                    otpErrorMessage.innerHTML='Invalid Code!!';
                    otpInput.classList.remove('is-valid');
                    otpInput.classList.add('is-invalid');
                    resetPasswordBtn.disabled = true;
                }
                else{
                    otpErrorMessage.innerHTML='';
                    otpInput.classList.remove('is-invalid');
                    otpInput.classList.add('is-valid');
                    resetPasswordBtn.disabled = false;
                }
            })
            .catch(error=>{
                console.log("Error :"+error);
            })
    }

</script>

</html>
