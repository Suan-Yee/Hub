<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
    <link rel="stylesheet" th:href="@{/static/assets/css/poll_report.css}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" integrity="sha512-SnH5WK+bZxgPHs44uWIX+LLJAJ9/2PkPKZ5QiAj6Ta86w+fsb2TkcmfRyVX3pBnMFcV7oQPJkl9QevSCWr3W6A==" crossorigin="anonymous" referrerpolicy="no-referrer"/>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
</head>
<style>
    .user-profile{
        width: 90px; /* Adjust this value as needed */
        height: 90px; /* Adjust this value as needed */
        border-radius: 50%; /* Ensures the image is circular */
        border: 2px solid #fff;
        box-shadow: 0 0 5px rgba(0,0,0,0.2);
    }
    .user-profile img{
        width: 100%; /* Ensures the image fills the container */
        height: 100%;
        object-fit: cover;
        display: block;
        border-radius: 50%;
    }
    .user-name{
        font-size: 12px;
        width:100px;
        padding: 4px 12px;
    }

    /* #detailModal .modal-body{
         display: flex;
         justify-content: flex-start;
     }*/
</style>
<body>
<div class="polls-container">
    <!-- Polls will be dynamically added here -->
</div>

<!-- Bootstrap Modal -->
<div class="modal fade" id="detailModal" tabindex="-1" aria-labelledby="detailModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="detailModalLabel"></h5>
                <span class="total-votes"></span>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <!-- Add content here -->
            </div>
        </div>
    </div>
</div>
</body>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
<script>
    let pollsData;
    const getPolls = async () => {
        const response = await fetch("/get-all-poll");
        const data = await response.json();
        pollsData = data;
        data.forEach(pollOption => {
            const poll = {
                id: pollOption.id,
                question: pollOption.question,
                answers: pollOption.answers,
                pollCount: pollOption.pollCount,
                answersWeight: pollOption.answersWeight,
                expiredDate : pollOption.expiredDate,
                selectedAnswer: -1
            };
            const pollHTML = createPollHTML(poll);
            appendPollToContainer(pollHTML);
            showResults(poll);
        });
    };

    const createPollHTML = (poll) => {

        let answersHTML = "";
        for (const [answerId, answer] of Object.entries(poll.answers)) {
            answersHTML += `
              <div class="answer">
                ${answer}
                <span class="percentage-bar"></span>
                <span class="percentage-value"></span>
            </div>
        <a class="option-detail" onclick="showDetail('${answerId}')">
        Show Detail</a>`;
        }

        return `
        <div class="poll" data-id="${poll.id}">
            <div class="question">${poll.question}
               <div class="pollInfo-container">
               <div class="totalVote">${poll.pollCount}votes</div>
             <div class="expiration-date">${poll.expiredDate}</div>
</div>
            </div>
            <div class="answers">${answersHTML}</div>
        </div>`;
    };

    const showDetail = (answerId)=>{
        console.log(answerId);
        fetch('get-votes-for-poll-option?answerId='+answerId,{
            method:'GET'
        })
            .then(response=>response.json())
            .then(data=>{
                console.log(data);
                const modalElement = document.getElementById('detailModal');
                const detailModal = new bootstrap.Modal(modalElement);
                const modalTitle = document.querySelector('.modal-title');
                const totalVotesSpan = document.querySelector('.total-votes');
                totalVotesSpan.textContent = `${data.voteCount} votes`;
                detailModal.show();

                modalTitle.innerHTML = data.name;
                const modalBody = document.querySelector('.modal-body');
                modalBody.innerHTML = ""; // Clear previous content

                if(data.users && data.users.length>0){

                    const userListHTML = data.users.map((user, index)=>{
                        const photoUrl = user.photo ? user.photo : "http://res.cloudinary.com/dwdplsd2c/image/upload/v1713536112/fllinoozg9hh1ghk5mef.png";
                        if (index % 5 === 0) {
                            return `
                            <div class="row user-row">
                                <div class="col">
                                    <div class="user-profile">
                                        <img src="${photoUrl}" alt="${user.name}">
                                    </div>
                                     <a href="/userprofile/${user.id}" class="user-name">${user.name}</a>
                                </div>`;
                        }else{
                            return `

                                <div class="col">
                                    <div class="user-profile">
                                        <img src="${photoUrl}" alt="${user.name}">
                                    </div>
                                     <a href="/userprofile/${user.id}" class="user-name">${user.name}</a>
                                </div>`;
                        }
                    }).join('');
                    modalBody.innerHTML = userListHTML;
                }else{
                    modalBody.innerHTML = "<p style='color: red'>No users voted for this option.</p>";
                }
            })
            .catch(error=>{
                console.error("Fail to fetch "+error);
            })


    }


    const appendPollToContainer = (pollHTML) => {
        const pollsContainer = document.querySelector('.polls-container');
        pollsContainer.innerHTML += pollHTML;
    };


    const showResults = (poll) => {
        const totalVotes = poll.pollCount;
        const answers = document.querySelectorAll(`.poll[data-id="${poll.id}"] .answers .answer`);

        answers.forEach((answer, i) => {
            let percentage = 0;
            if (totalVotes > 0) {
                percentage = Math.round((poll.answersWeight[i]) * 100 / totalVotes);
            }
            answer.querySelector(".percentage-bar").style.width = percentage + "%";
            answer.querySelector(".percentage-value").innerText = percentage + "%";
        });
    };
    getPolls();
</script>
</html>
